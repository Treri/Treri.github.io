<!DOCTYPE html>
<html id="J-html" class="">
<head>
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>WP3.1.2-完美自动保存,禁用版本控制 | 自说Me话</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="WP3.1.2-完美自动保存,禁用版本控制" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="前两天把wp的默认表情图片的路径改了一下,然后又看了下木木的文章新窗口中打开评论者链接 感觉没有什么东西值得留恋的了." />
<meta property="og:description" content="前两天把wp的默认表情图片的路径改了一下,然后又看了下木木的文章新窗口中打开评论者链接 感觉没有什么东西值得留恋的了." />
<link rel="canonical" href="http://isay.me/2011/05/perfect-autosave-disable-version-control.html" />
<meta property="og:url" content="http://isay.me/2011/05/perfect-autosave-disable-version-control.html" />
<meta property="og:site_name" content="自说Me话" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-05-10T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="WP3.1.2-完美自动保存,禁用版本控制" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2011-05-10T00:00:00+08:00","datePublished":"2011-05-10T00:00:00+08:00","description":"前两天把wp的默认表情图片的路径改了一下,然后又看了下木木的文章新窗口中打开评论者链接 感觉没有什么东西值得留恋的了.","headline":"WP3.1.2-完美自动保存,禁用版本控制","mainEntityOfPage":{"@type":"WebPage","@id":"http://isay.me/2011/05/perfect-autosave-disable-version-control.html"},"url":"http://isay.me/2011/05/perfect-autosave-disable-version-control.html"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="http://isay.me/feed.xml" title="自说Me话" />
  <link rel="stylesheet" type="text/css" media="all" href="/assets/css/style.css" />
  
</head>
<body itemscope itemtype="http://schema.org/WebPage" class="home blog lotus index">
  
  <nav class="lotus-nav">
  <ul>
    
    
    
    
    
    <li class="home ">
      
      <a href="/" rel="bookmark" title="首页">
        <i class="fa fa-home"></i>
      </a>
      
    </li>
    
    
    
    
    
    <li class=" ">
      
      <a href="/archives.html" rel="bookmark" title="文章归档">
        <i class="fa fa-reorder"></i>
      </a>
      
    </li>
    
    
    
    
    
    <li class=" ">
      
      <a href="/tags.html" rel="bookmark" title="文章标签">
        <i class="fa fa-tags"></i>
      </a>
      
    </li>
    

    
    
    
    
    
    <li class=" ">
      
      <a href="/contact.html" rel="bookmark" title="关于我">
        <i class="fa fa-user"></i>
      </a>
      
    </li>
    
  </ul>
</nav>

  <p class="lotus-breadcrub">
  <a href="/" rel="nofollow" rel="nofollow" title="首页">首页</a>
  <span> &gt; </span>
  <a href="/archives.html" rel="nofollow" >文章归档</a>
  <span> &gt; </span>
  WP3.1.2-完美自动保存,禁用版本控制
</p>
<h1 class="lotus-pagetit">WP3.1.2-完美自动保存,禁用版本控制</h1>
<p class="lotus-meta">Publish: <time class="date" pubdate="May 10, 2011">May 10, 2011</time></p>
<article  itemscope itemtype="http://schema.org/Article" class="lotus-post lotus-post-columns-1">
<p>前两天把wp的默认表情图片的路径改了一下,然后又看了下木木的文章<a href="http://immmmm.com/jquery-notes-open-comment-link-new-window.html">新窗口中打开评论者链接</a> 感觉没有什么东西值得留恋的了.</p>

<p>况且好多人都说3.1.2版本修复了几个很严重的漏洞,我也有点害怕不升级会不会造成神马影响,所以就在后台把wp升级到了3.1.2版本.升级完我才想起来,自动保存,版本控制这些玩意我忘记啦.OMG!又要重新鼓捣啦.</p>

<p>原来修改的方法没有记录下来,只好去google上搜索,嘿,没想到搜到了更完美的方法,既保留自动保存,又可以保持文章ID连续,禁用版本控制.这么好的事,一定要试试.不成功也是尝试嘛.所以就按照文章中的方法试验了一遍.果真可以.哈哈.</p>

<p>而且这个方法还有一个好处就是,貌似可以把你原来删掉的那些auto draft的ID利用起来.(不太确定,因为我在本地试验的,谁知道是不是这样,但是使用自动保存的同时禁用版本控制,这个方法是真正的做到了.)</p>

<p><strong>update:</strong>确定此方法会将原来的ID利用起来.因为我最新的文章ID是125,但是此篇文章的ID是122.应该是把没用到的ID给利用起来了.
下面就说说方法,欢迎大家一起折腾.哈哈</p>

<p>原文地址<a href="http://www.jiechic.com/archives/perfect-auto-save-disable-version-control-continuous-article-id.html">完美自动保存、禁用版本控制、连续文章ID</a></p>

<p><strong>首先 关闭修订版本</strong></p>

<p><strong>原文的话如下</strong>
这个有很多方法，一下三种方法，只用一种即可。</p>

<p>1、修改源代码去掉钩子.
在wp-includes/default-filters.php中，可以看到这一行：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add_action( 'pre_post_update', 'wp_save_post_revision' );
</code></pre></div></div>

<p>将其注释掉，修改后，为</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//add_action( 'pre_post_update', 'wp_save_post_revision' );
</code></pre></div></div>

<p>2、使用插件，关闭修订版本.
原理是，插件启用一个函数，去掉这个修订版本的钩子。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remove_action ( 'pre_post_update', 'wp_save_post_revision' );
</code></pre></div></div>

<p>或者是定义修订版本选项，使其修订版本功能关闭</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>define('WP_POST_REVISIONS',false);
</code></pre></div></div>

<p>3、配置文件添加修订版本选项，使修订版本功能关闭.
编辑 wp-config.php 文件（博客根目录），在下面代码之前：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>define('ABSPATH', dirname(__FILE__).'/');
</code></pre></div></div>

<p>添加以下代码：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>define('WP_POST_REVISIONS',false);
</code></pre></div></div>

<p><em>原文作者注，define(‘WP_POST_REVISIONS’,false);的这种方法，我现在也不知道可不可用，如果有哪位童鞋使用这种方法可以停止修订版本功能的，留言告知，我好完善该文章，懒了，不想一个一个去测试了。</em></p>

<p><strong>SayMe:</strong>我使用的是第一种方法.当我查看我的wp-config.php的时候,貌似里面还有第三种方法.这个应该是原来按照人家的教程修改的时候留下来的.</p>

<p><strong>二,继续自动保存，关闭自动保存的新增版本</strong></p>

<p>在wp-admin/includes/post.php文件中，搜索”wp_create_post_autosave”，不含引号。找到如下函数：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function wp_create_post_autosave( $post_id ) {
    $translated = _wp_translate_postdata( true );
    if ( is_wp_error( $translated ) )
        return $translated; // Only store one autosave. If there is already an autosave, overwrite it.
    if ( $old_autosave = wp_get_post_autosave( $post_id ) ) {
        $new_autosave = _wp_post_revision_fields( $_POST, true );
         $new_autosave['ID'] = $old_autosave-&gt;ID;
        return wp_update_post( $new_autosave );
    } // Otherwise create the new autosave as a special post revision
    return _wp_put_post_revision( $_POST, true );
} 将如下函数

return _wp_put_post_revision( $_POST, true ); 替换为

return edit_post();
</code></pre></div></div>

<p><strong>三,关闭自动草稿</strong></p>

<p>找到/wp-admin/includes/post.php文件，搜索”$create_in_db”，不含引号。找到如下函数：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if ( $create_in_db ) {
    // Cleanup old auto-drafts more than 7 days old
    $old_posts = $wpdb-&gt;get_col( "SELECT ID FROM $wpdb-&gt;posts WHERE post_status = 'auto-draft' AND DATE_SUB( NOW(), INTERVAL 7 DAY ) &gt; post_date" );
    foreach ( (array) $old_posts as $delete )
        wp_delete_post( $delete, true ); // Force delete
    $post_id = wp_insert_post( array( 'post_title' =&gt; __( 'Auto Draft' ), 'post_type' =&gt; $post_type, 'post_status' =&gt; 'auto-draft' ) );
    $post = get_post( $post_id );
    // Below is added in 3.1
    if ( current_theme_supports( 'post-formats' ) &amp;&amp; post_type_supports( $post-&gt;post_type, 'post-formats' ) &amp;&amp; get_option( 'default_post_format' ) )
        set_post_format( $post, get_option( 'default_post_format' ) );
} else {
    $post-&gt;ID = 0;
    $post-&gt;post_author = '';
    $post-&gt;post_date = '';
    $post-&gt;post_date_gmt = '';
    $post-&gt;post_password = '';
    $post-&gt;post_type = $post_type;
    $post-&gt;post_status = 'draft';
    $post-&gt;to_ping = '';
    $post-&gt;pinged = '';
    $post-&gt;comment_status = get_option( 'default_comment_status' );
    $post-&gt;ping_status = get_option( 'default_ping_status' );
    $post-&gt;post_pingback = get_option( 'default_pingback_flag' );
    $post-&gt;post_category = get_option( 'default_category' );
    $post-&gt;page_template = 'default';
    $post-&gt;post_parent = 0;
    $post-&gt;menu_order = 0;
} 修改 if ｛｝else 之间的函数，修改代码后如下，你可以直接复制粘贴。

if ( $create_in_db ) {
    global $current_user;
    $post = $wpdb-&gt;get_row( "SELECT * FROM $wpdb-&gt;posts WHERE post_status = 'auto-draft' AND post_type = '$post_type' AND post_author = $current_user-&gt;ID ORDER BY ID ASC LIMIT 1" );
    if ( !$post ) {
        $post_id = wp_insert_post( array( 'post_title' =&gt; __( 'Auto Draft' ), 'post_type' =&gt; $post_type, 'post_status' =&gt; 'auto-draft' ) );
        $post = get_post( $post_id );
    }
    /* End */
    // Below is added in 3.1
    if ( current_theme_supports( 'post-formats' ) &amp;&amp; post_type_supports( $post-&gt;post_type, 'post-formats' ) &amp;&amp; get_option( 'default_post_format' ) )
        set_post_format( $post, get_option( 'default_post_format' ) );
} else {
</code></pre></div></div>

<p><em>注else之后的函数不变,请对照修改else之前的内容</em></p>

<p>经过这一系列的源码修改后,既可以使用自动保存的功能,又不会产生多余的文章ID啦.哈哈.又可以把super switch插件干掉啦.霍霍~~</p>

<p><strong>严重提醒:</strong></p>

<p>如果你的wp-config.php文件里面有原来关闭自动保存的时候留下的如下语句</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>define('AUTOSAVE_INTERVAL', false); 的话,请注释掉.因为此文章中的方法是保留自动保存的功能,如果config中继续有这句话,在新建文章的时候会引起强烈冲突,导致服务器负荷急剧上升.如果不信的话,可以在本地服务器测试一下.切记切记!!!!!否则出现问题.不负责....
</code></pre></div></div>

<p><img src="/uploads/2011/05/10_01.png" alt="" /></p>

</article>
<p class="lotus-anno">声明: 本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="nofollow" target="_blank" title="自由转载-非商用-非衍生-保持署名">BY-NC-SA</a> 授权。转载请注明转自: <a href="http://isay.me/2011/05/perfect-autosave-disable-version-control.html" title="" rel="nofollow">WP3.1.2-完美自动保存,禁用版本控制 - 自说Me话</a></p>
<section class="lotus-nextpage fn-clear">
  
  <div class="lotus-nextpage-left"><a class="prev" href="/2011/05/linux-note-summary.html" rel="prev">&laquo;&nbsp;Linux记录总结</a></div>
  
  
  <div class="lotus-nextpage-right"><a class="next" href="/2011/05/wp-head-redundant-code.html" rel="next">转-去除wp头部代码中不需要的&nbsp;&raquo;</a></div>
  
</section>


  <div id="comments">
  
      
        <div id="disqus_thread"></div>
<script>
  function disqus_config() {
      this.page.url = "http://isay.me/2011/05/perfect-autosave-disable-version-control.html";
      this.page.identifier = "122";
      this.page.title = "WP3.1.2-完美自动保存,禁用版本控制";
  };

  (function() {
      var d = document, s = d.createElement('script');
      s.src = '//isaymesite.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      
  
  </div>




  <footer class="lotus-footer">
  <p>Copyright © 2011–2023 自说Me话 All rights reserved. Design by <a href="http://www.zhanxin.info" target="_blank">zhanxin</a>.</p>
</footer>
  
</body>
</html>
