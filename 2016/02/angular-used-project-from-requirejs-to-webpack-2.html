<!DOCTYPE html>
<html id="J-html" class="">
<head>
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>在Angular.js项目中使用异步加载(二) | 自说Me话</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="在Angular.js项目中使用异步加载(二)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="上篇讲了, 在以 Angular.js 为框架的项目中, 使用 RequireJS 进行模块化加载的关键代码. 本篇介绍如何将上述的代码应用到实际中." />
<meta property="og:description" content="上篇讲了, 在以 Angular.js 为框架的项目中, 使用 RequireJS 进行模块化加载的关键代码. 本篇介绍如何将上述的代码应用到实际中." />
<link rel="canonical" href="http://isay.me/2016/02/angular-used-project-from-requirejs-to-webpack-2.html" />
<meta property="og:url" content="http://isay.me/2016/02/angular-used-project-from-requirejs-to-webpack-2.html" />
<meta property="og:site_name" content="自说Me话" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-02-26T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="在Angular.js项目中使用异步加载(二)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2016-02-26T00:00:00+08:00","datePublished":"2016-02-26T00:00:00+08:00","description":"上篇讲了, 在以 Angular.js 为框架的项目中, 使用 RequireJS 进行模块化加载的关键代码. 本篇介绍如何将上述的代码应用到实际中.","headline":"在Angular.js项目中使用异步加载(二)","mainEntityOfPage":{"@type":"WebPage","@id":"http://isay.me/2016/02/angular-used-project-from-requirejs-to-webpack-2.html"},"url":"http://isay.me/2016/02/angular-used-project-from-requirejs-to-webpack-2.html"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="http://isay.me/feed.xml" title="自说Me话" />
  <link rel="stylesheet" type="text/css" media="all" href="/assets/css/style.css" />
  
</head>
<body itemscope itemtype="http://schema.org/WebPage" class="home blog lotus index">
  
  <nav class="lotus-nav">
  <ul>
    
    
    
    
    
    <li class="home ">
      
      <a href="/" rel="bookmark" title="首页">
        <i class="fa fa-home"></i>
      </a>
      
    </li>
    
    
    
    
    
    <li class=" ">
      
      <a href="/archives.html" rel="bookmark" title="文章归档">
        <i class="fa fa-reorder"></i>
      </a>
      
    </li>
    
    
    
    
    
    <li class=" ">
      
      <a href="/tags.html" rel="bookmark" title="文章标签">
        <i class="fa fa-tags"></i>
      </a>
      
    </li>
    

    
    
    
    
    
    <li class=" ">
      
      <a href="/contact.html" rel="bookmark" title="关于我">
        <i class="fa fa-user"></i>
      </a>
      
    </li>
    
  </ul>
</nav>

  <p class="lotus-breadcrub">
  <a href="/" rel="nofollow" rel="nofollow" title="首页">首页</a>
  <span> &gt; </span>
  <a href="/archives.html" rel="nofollow" >文章归档</a>
  <span> &gt; </span>
  在Angular.js项目中使用异步加载(二)
</p>
<h1 class="lotus-pagetit">在Angular.js项目中使用异步加载(二)</h1>
<p class="lotus-meta">Publish: <time class="date" pubdate="February 26, 2016">February 26, 2016</time></p>
<article  itemscope itemtype="http://schema.org/Article" class="lotus-post lotus-post-columns-1">
<p>上篇讲了, 在以 Angular.js 为框架的项目中, 使用 <code class="language-plaintext highlighter-rouge">RequireJS</code> 进行模块化加载的关键代码. 本篇介绍如何将上述的代码应用到实际中.</p>

<p>首先创建一个典型的项目结构</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── controllers/
├── directives/
├── services/
├── styles/
├── views/
├── app.js
└── boot.js
</code></pre></div></div>

<p>app.js 中的主要内容如下</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="dl">'</span><span class="s1">demo</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span>
    <span class="dl">'</span><span class="s1">ui.router</span><span class="dl">'</span>
  <span class="p">]);</span>

  <span class="c1">// 看我将上篇中讲到的代码放在这里</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">config</span><span class="p">([</span>
    <span class="dl">'</span><span class="s1">$controllerProvider</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">$compileProvider</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">$filterProvider</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">$provide</span><span class="dl">'</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">$controllerProvider</span><span class="p">,</span> <span class="nx">$compileProvider</span><span class="p">,</span> <span class="nx">$filterProvider</span><span class="p">,</span> <span class="nx">$provide</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">controller</span> <span class="o">=</span> <span class="nx">$controllerProvider</span><span class="p">.</span><span class="nx">register</span><span class="p">;</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">directive</span> <span class="o">=</span> <span class="nx">$compileProvider</span><span class="p">.</span><span class="nx">directive</span><span class="p">;</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">filter</span> <span class="o">=</span> <span class="nx">$filterProvider</span><span class="p">.</span><span class="nx">register</span><span class="p">;</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">factory</span> <span class="o">=</span> <span class="nx">$provide</span><span class="p">.</span><span class="nx">factory</span><span class="p">;</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">service</span> <span class="o">=</span> <span class="nx">$provide</span><span class="p">.</span><span class="nx">service</span><span class="p">;</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">provider</span> <span class="o">=</span> <span class="nx">$provide</span><span class="p">.</span><span class="nx">provider</span><span class="p">;</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">$provide</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">constant</span> <span class="o">=</span> <span class="nx">$provide</span><span class="p">.</span><span class="nx">constant</span><span class="p">;</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">decorator</span> <span class="o">=</span> <span class="nx">$provide</span><span class="p">.</span><span class="nx">decorator</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">]);</span>

  <span class="c1">// 在这里进行正常的路由定义</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">config</span><span class="p">([</span>
    <span class="dl">'</span><span class="s1">$stateProvider</span><span class="dl">'</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">$stateProvider</span><span class="p">){</span>
      <span class="nx">$stateProvider</span>
        <span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="dl">'</span><span class="s1">state1</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/state1</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">template</span><span class="p">:</span> <span class="dl">'</span><span class="s1">views/state1.html</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">controller</span><span class="p">:</span> <span class="dl">'</span><span class="s1">state1Ctrl</span><span class="dl">'</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="dl">'</span><span class="s1">state2</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/satte2</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">template</span><span class="p">:</span> <span class="dl">'</span><span class="s1">views/state2.html</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">controller</span><span class="p">:</span> <span class="dl">'</span><span class="s1">state2Ctrl</span><span class="dl">'</span>
        <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">]);</span>

  <span class="c1">// 在这里需要将 app 返回, 才能保证在其它地方, define(['app'], factory) 的时候, factory能够得到 app</span>
  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<p>而boot.js中的内容就很简单了, 只是调用 app.js, 然后进行初项目始化</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
  <span class="na">baseUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./</span><span class="dl">'</span>
<span class="p">});</span>

<span class="nx">require</span><span class="p">([</span>
  <span class="dl">'</span><span class="s1">app</span><span class="dl">'</span>
<span class="p">],</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">angular</span><span class="p">.</span><span class="nx">bootstrap</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">demo</span><span class="dl">'</span><span class="p">]);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>这样就完了吗? 当然没有. 此时只是一个基本结构完成了. 但是还没法做到异步加载controller, directive等.</p>

<p>我们需要找到一个加载时机, 可以让我们在切换到相应的路由时, 进行文件的加载. 我选择的是 <code class="language-plaintext highlighter-rouge">$stateProvider</code> 定义路由时的<code class="language-plaintext highlighter-rouge">resolve</code>对象. 按照ui-router的文档中说的</p>

<blockquote>
  <p>resolve: An optional map&lt;string, function&gt; of dependencies which should be injected into the controller. If any of these dependencies are promises, the router will wait for them all to be resolved before the controller is instantiated. If all the promises are resolved successfully, the $stateChangeSuccess event is fired and the values of the resolved promises are injected into any controllers that reference them. If any of the promises are rejected the $stateChangeError event is fired.</p>
</blockquote>

<p>在这里, 我们可以返回一个 promise, 然后使用 require.js 进行文件加载, 等待文件加载完毕后, 改变 promise 的状态, 然后让 ui-router 进行相应路由的初始化.</p>

<p>所以, <code class="language-plaintext highlighter-rouge">$stateProvider</code> 定义路由的写法进行一些修改</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$stateProvider</span>
  <span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="dl">'</span><span class="s1">state1</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/state1</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">templateUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">views/state1.html</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">controller</span><span class="p">:</span> <span class="dl">'</span><span class="s1">state1Ctrl</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">resolve</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">deps</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$q</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">$rootScope</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$q</span><span class="p">,</span> <span class="nx">$rootScope</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
        <span class="nx">require</span><span class="p">([</span>
          <span class="dl">'</span><span class="s1">controllers/state1Ctrl</span><span class="dl">'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">(</span><span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
      <span class="p">}]</span>
    <span class="p">}</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>这样的话, 在 state1 进行初始化的时候, 可以保证对应的 controller 文件已经加载完毕. 在 controller 中, 就是正常的写法了</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">define</span><span class="p">([</span>
  <span class="dl">'</span><span class="s1">app</span><span class="dl">'</span>
<span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">){</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">state1Ctrl</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span>
    <span class="dl">'</span><span class="s1">$scope</span><span class="dl">'</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">){</span>
      <span class="c1">// code here</span>
    <span class="p">}</span>
  <span class="p">])</span>
<span class="p">});</span>
</code></pre></div></div>

<p>如果你使用了 require.js 的 css 插件的话, 完全可以在这里也把 css 文件加载进来.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$stateProvider</span>
  <span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="dl">'</span><span class="s1">state1</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/state1</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">templateUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">views/state1.html</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">controller</span><span class="p">:</span> <span class="dl">'</span><span class="s1">state1Ctrl</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">resolve</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">deps</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$q</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">$rootScope</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$q</span><span class="p">,</span> <span class="nx">$rootScope</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
        <span class="nx">require</span><span class="p">([</span>
          <span class="dl">'</span><span class="s1">controllers/state1Ctrl</span><span class="dl">'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">(</span><span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
      <span class="p">}],</span>
      <span class="na">css</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$q</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">$rootScope</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$q</span><span class="p">,</span> <span class="nx">$rootScope</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
        <span class="nx">require</span><span class="p">([</span>
          <span class="dl">'</span><span class="s1">css!styles/state1Ctrl</span><span class="dl">'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">(</span><span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
      <span class="p">}],</span>
    <span class="p">}</span>
  <span class="p">})</span>
</code></pre></div></div>

<p>你可以将这些代码进行抽象, 封装成一个方法. 对于 css 文件的加载, 可以在开发模式, 使用 <code class="language-plaintext highlighter-rouge">RequireJS</code> 进行加载. 而在发布模式时, 不单独加载 css 文件, 而是配合下篇讲的方法, 将 css 的内容注入到对应的 controller 中.</p>

<p>为了简化代码, 我写了一个 angular 的 模块, <a href="https://github.com/Wyntau/angular-require">angular-require</a>. 本篇写的代码, 就是这个小项目的原型.</p>

<p>在以 Angular.js 为框架的项目中, 使用 <code class="language-plaintext highlighter-rouge">RequireJS</code> 进行代码的异步加载, 其实并不是很难, 下篇将写一下, 在这样的项目中, 怎么对代码进行构建发布.</p>

</article>
<p class="lotus-anno">声明: 本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="nofollow" target="_blank" title="自由转载-非商用-非衍生-保持署名">BY-NC-SA</a> 授权。转载请注明转自: <a href="http://isay.me/2016/02/angular-used-project-from-requirejs-to-webpack-2.html" title="" rel="nofollow">在Angular.js项目中使用异步加载(二) - 自说Me话</a></p>
<section class="lotus-nextpage fn-clear">
  
  <div class="lotus-nextpage-left"><a class="prev" href="/2016/02/angular-used-project-from-requirejs-to-webpack-1.html" rel="prev">&laquo;&nbsp;在Angular.js项目中使用异步加载(一)</a></div>
  
  
  <div class="lotus-nextpage-right"><a class="next" href="/2016/02/angular-used-project-from-requirejs-to-webpack-3.html" rel="next">在Angular.js项目中使用异步加载(三)&nbsp;&raquo;</a></div>
  
</section>


  <div id="comments">
  
      
        <div id="disqus_thread"></div>
<script>
  function disqus_config() {
      this.page.url = "http://isay.me/2016/02/angular-used-project-from-requirejs-to-webpack-2.html";
      this.page.identifier = "2016022602";
      this.page.title = "在Angular.js项目中使用异步加载(二)";
  };

  (function() {
      var d = document, s = d.createElement('script');
      s.src = '//isaymesite.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      
  
  </div>




  <footer class="lotus-footer">
  <p>Copyright © 2011–2023 自说Me话 All rights reserved. Design by <a href="http://www.zhanxin.info" target="_blank">zhanxin</a>.</p>
</footer>
  
</body>
</html>
