<!DOCTYPE html>
<html id="J-html" class="">
<head>
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>在Angular.js项目中使用异步加载(六) - 动态加载第三方模块 | 自说Me话</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="在Angular.js项目中使用异步加载(六) - 动态加载第三方模块" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="在 Anguarl.js 中使用异步加载, 并配合构建工具, 基本已经可以在生产环境中进行使用. 但是还有一些情况并没有覆盖到." />
<meta property="og:description" content="在 Anguarl.js 中使用异步加载, 并配合构建工具, 基本已经可以在生产环境中进行使用. 但是还有一些情况并没有覆盖到." />
<link rel="canonical" href="http://isay.me/2016/03/angular-used-project-from-requirejs-to-webpack-6.html" />
<meta property="og:url" content="http://isay.me/2016/03/angular-used-project-from-requirejs-to-webpack-6.html" />
<meta property="og:site_name" content="自说Me话" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-03-19T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="在Angular.js项目中使用异步加载(六) - 动态加载第三方模块" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2016-03-19T00:00:00+08:00","datePublished":"2016-03-19T00:00:00+08:00","description":"在 Anguarl.js 中使用异步加载, 并配合构建工具, 基本已经可以在生产环境中进行使用. 但是还有一些情况并没有覆盖到.","headline":"在Angular.js项目中使用异步加载(六) - 动态加载第三方模块","mainEntityOfPage":{"@type":"WebPage","@id":"http://isay.me/2016/03/angular-used-project-from-requirejs-to-webpack-6.html"},"url":"http://isay.me/2016/03/angular-used-project-from-requirejs-to-webpack-6.html"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="http://isay.me/feed.xml" title="自说Me话" />
  <link rel="stylesheet" type="text/css" media="all" href="/assets/css/style.css" />
  
</head>
<body itemscope itemtype="http://schema.org/WebPage" class="home blog lotus index">
  
  <nav class="lotus-nav">
  <ul>
    
    
    
    
    
    <li class="home ">
      
      <a href="/" rel="bookmark" title="首页">
        <i class="fa fa-home"></i>
      </a>
      
    </li>
    
    
    
    
    
    <li class=" ">
      
      <a href="/archives.html" rel="bookmark" title="文章归档">
        <i class="fa fa-reorder"></i>
      </a>
      
    </li>
    
    
    
    
    
    <li class=" ">
      
      <a href="/tags.html" rel="bookmark" title="文章标签">
        <i class="fa fa-tags"></i>
      </a>
      
    </li>
    

    
    
    
    
    
    <li class=" ">
      
      <a href="/contact.html" rel="bookmark" title="关于我">
        <i class="fa fa-user"></i>
      </a>
      
    </li>
    
  </ul>
</nav>

  <p class="lotus-breadcrub">
  <a href="/" rel="nofollow" rel="nofollow" title="首页">首页</a>
  <span> &gt; </span>
  <a href="/archives.html" rel="nofollow" >文章归档</a>
  <span> &gt; </span>
  在Angular.js项目中使用异步加载(六) - 动态加载第三方模块
</p>
<h1 class="lotus-pagetit">在Angular.js项目中使用异步加载(六) - 动态加载第三方模块</h1>
<p class="lotus-meta">Publish: <time class="date" pubdate="March 19, 2016">March 19, 2016</time></p>
<article  itemscope itemtype="http://schema.org/Article" class="lotus-post lotus-post-columns-1">
<p>在 Anguarl.js 中使用异步加载, 并配合构建工具, 基本已经可以在生产环境中进行使用. 但是还有一些情况并没有覆盖到.</p>

<p>比如, 整个项目的某个页面需要依赖第三方模块, 但是以 Angular.js 加载模块的方式, 就需要在页面初始化之前把第三方模块加载完毕, 同时在项目初始化的依赖部分加以引用, 打包资源时, 就需要把这个依赖同样引入. 这样就会造成加载资源的浪费.</p>

<p>由于目前我所在的项目中, 基本都是些全局依赖, 所以没有遇到这种需求. 也是这个原因, 导致我对这个方向没有做过研究. 但是没需求不代表没问题, 如果某天我也遇到了这样的问题, 可能就要费一番功夫了.</p>

<p>正好在SegmentFault上看到一篇文章, 讲述怎么动态加载第三方模块, 并在项目中进行了试验, 可以解决这个问题.</p>

<p>文章地址 <a href="https://segmentfault.com/a/1190000004487211?_ea=632149">angularjs+requirejs实现按需加载的全面实践</a>, 还有一篇英文的 <a href="http://benohead.com/angularjs-requirejs-dynamic-loading-and-pluggable-views/">AngularJS: RequireJS, dynamic loading and pluggable views</a>, 这篇中我只看了其中动态加载模块的部分.</p>

<p>解决方法, 就是按照正常加载模块的流程, 将 Angular.js 内部的逻辑走一遍.</p>

<p>一个模块在定义时, 会有好多方法, 比如 <code class="language-plaintext highlighter-rouge">controller</code>, <code class="language-plaintext highlighter-rouge">directive</code>, <code class="language-plaintext highlighter-rouge">filter</code>, <code class="language-plaintext highlighter-rouge">factory</code>, <code class="language-plaintext highlighter-rouge">service</code>, <code class="language-plaintext highlighter-rouge">provider</code>, <code class="language-plaintext highlighter-rouge">value</code>, <code class="language-plaintext highlighter-rouge">constant</code>, <code class="language-plaintext highlighter-rouge">decorator</code>. 但是调用这些方法的最终结果, 是把那些具体的逻辑放入三个数组中, 这三个数组为</p>

<ul>
  <li>module._invokeQueue</li>
  <li>module._configBlocks</li>
  <li>module._runBlocks</li>
</ul>

<p>等到需要使用这个模块的时候, 再进行执行. 在 Angular.js 中, 如果不在项目的定义时引入依赖, 即使加载了第三方模块也不能用的原因就是因为, 第三方模块只进行了定义, 而那些具体的逻辑并没有得到执行, 所以才会报各种 *Provider 找不到的错误.</p>

<p>动态加载第三方模块的关键就是将第三方模块的初始化逻辑进行执行. 所以我们将 app.js 中的 config 部分进行改写.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">config</span><span class="p">([</span>
  <span class="dl">'</span><span class="s1">$controllerProvider</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">$compileProvider</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">$filterProvider</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">$provide</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">$injector</span><span class="dl">'</span><span class="p">,</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">$controllerProvider</span><span class="p">,</span> <span class="nx">$compileProvider</span><span class="p">,</span> <span class="nx">$filterProvider</span><span class="p">,</span> <span class="nx">$provide</span><span class="p">,</span> <span class="nx">$injector</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">controller</span> <span class="o">=</span> <span class="nx">$controllerProvider</span><span class="p">.</span><span class="nx">register</span><span class="p">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">directive</span> <span class="o">=</span> <span class="nx">$compileProvider</span><span class="p">.</span><span class="nx">directive</span><span class="p">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">filter</span> <span class="o">=</span> <span class="nx">$filterProvider</span><span class="p">.</span><span class="nx">register</span><span class="p">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">factory</span> <span class="o">=</span> <span class="nx">$provide</span><span class="p">.</span><span class="nx">factory</span><span class="p">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">service</span> <span class="o">=</span> <span class="nx">$provide</span><span class="p">.</span><span class="nx">service</span><span class="p">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">provider</span> <span class="o">=</span> <span class="nx">$provide</span><span class="p">.</span><span class="nx">provider</span><span class="p">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">$provide</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">constant</span> <span class="o">=</span> <span class="nx">$provide</span><span class="p">.</span><span class="nx">constant</span><span class="p">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">decorator</span> <span class="o">=</span> <span class="nx">$provide</span><span class="p">.</span><span class="nx">decorator</span><span class="p">;</span>

    <span class="c1">// 在这里定义一个新的全局方法, 方便进行第三方模块的加载</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">Library</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

      <span class="kd">var</span> <span class="nx">providers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="dl">'</span><span class="s1">$controllerProvider</span><span class="dl">'</span><span class="p">:</span> <span class="nx">$controllerProvider</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">$compileProvider</span><span class="dl">'</span><span class="p">:</span> <span class="nx">$compileProvider</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">$filterProvider</span><span class="dl">'</span><span class="p">:</span> <span class="nx">$filterProvider</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">$provide</span><span class="dl">'</span><span class="p">:</span> <span class="nx">$provide</span>
      <span class="p">};</span>

      <span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="k">return</span> <span class="kd">function</span> <span class="nx">Library</span><span class="p">(</span><span class="nx">module</span><span class="p">){</span>

        <span class="c1">// already activated</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">cache</span><span class="p">[</span><span class="nx">module</span><span class="p">]){</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="nx">module</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">requires</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">requires</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Library</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">requires</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">invokeArgs</span><span class="p">,</span> <span class="nx">provider</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">args</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">_invokeQueue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
          <span class="nx">invokeArgs</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">_invokeQueue</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="nx">provider</span> <span class="o">=</span> <span class="nx">providers</span><span class="p">[</span><span class="nx">invokeArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
          <span class="nx">method</span> <span class="o">=</span> <span class="nx">invokeArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="nx">args</span> <span class="o">=</span> <span class="nx">invokeArgs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
          <span class="nx">provider</span><span class="p">[</span><span class="nx">method</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">provider</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">_configBlocks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
          <span class="nx">$injector</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">_configBlocks</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">_runBlocks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
          <span class="nx">$injector</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">_runBlocks</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="nx">cache</span><span class="p">[</span><span class="nx">module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">})();</span>
  <span class="p">}</span>
<span class="p">]);</span>
</code></pre></div></div>

<p>使用方法很简单, 假如有一个第三方模块按照正常的模块定义方式进行书写. 我们可以有一个只进行引入第三方模块的文件. 在这个模块中, 进行第三方模块的载入工作.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">define</span><span class="p">([</span>
  <span class="dl">'</span><span class="s1">path/to/library.js</span><span class="dl">'</span>
<span class="p">],</span> <span class="nx">Ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
  <span class="nx">Library</span><span class="p">(</span><span class="dl">'</span><span class="s1">libraryName</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}));</span>
</code></pre></div></div>

<p>当我们在其它文件需要加载此第三方模块时, 不去依赖原文件, 而是依赖我们写的文件即可</p>

</article>
<p class="lotus-anno">声明: 本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="nofollow" target="_blank" title="自由转载-非商用-非衍生-保持署名">BY-NC-SA</a> 授权。转载请注明转自: <a href="http://isay.me/2016/03/angular-used-project-from-requirejs-to-webpack-6.html" title="" rel="nofollow">在Angular.js项目中使用异步加载(六) - 动态加载第三方模块 - 自说Me话</a></p>
<section class="lotus-nextpage fn-clear">
  
  <div class="lotus-nextpage-left"><a class="prev" href="/2016/03/angular-used-project-from-requirejs-to-webpack-5.html" rel="prev">&laquo;&nbsp;在Angular.js项目中使用异步加载(五)</a></div>
  
  
  <div class="lotus-nextpage-right"><a class="next" href="/2016/04/use-systemjs-as-es6-loader.html" rel="next">使用 System.js 作为 ES6 的加载器...&nbsp;&raquo;</a></div>
  
</section>


  <div id="comments">
  
      
        <div id="disqus_thread"></div>
<script>
  function disqus_config() {
      this.page.url = "http://isay.me/2016/03/angular-used-project-from-requirejs-to-webpack-6.html";
      this.page.identifier = "2016031901";
      this.page.title = "在Angular.js项目中使用异步加载(六) - 动态加载第三方模块";
  };

  (function() {
      var d = document, s = d.createElement('script');
      s.src = '//isaymesite.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      
  
  </div>




  <footer class="lotus-footer">
  <p>Copyright © 2011–2023 自说Me话 All rights reserved. Design by <a href="http://www.zhanxin.info" target="_blank">zhanxin</a>.</p>
</footer>
  
</body>
</html>
